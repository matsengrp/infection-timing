---
title: "Infection timing analysis"
output:
  html_document:
    toc: true
    toc_depth: 2
    dev: 'svg'
---

```{r echo=TRUE, message=FALSE, warning=FALSE}
library(ggplot2)
library(devtools)
library(gridExtra)
library(ggpubr)
library(data.table)
library(Metrics)
library(tidyverse)

source("common_plot.R")

knitr::opts_chunk$set(fig.width=16, fig.height=8)

```

```{r warning=FALSE, results='hide'}
# Set working directory
setwd("/Users/magdalenarussell/Documents/Matsen_group/infection-timing")

# Load existing data as `all_runs` file
all_runs = read.csv("_ignore/AllRunsAvg.csv")

# Load Neher paper test data as `Neher_data` file
neher_data = read.csv("_ignore/Neher_test_data_time_vl_df.tsv", sep = "\t")
```

The following plots show the estimated time of infection(ETI) (as calculated using the Neher equation) versus the actual time of infection (TI) (time since birth). Note that average pairwise diversity (APD) parameters change for each plot (color of regression line indicates different APD cutoff). Note that we are also varying runs analyzed and fragments analyzed. The points are shaped either by Run number or by patient ID (Sample). The blue dotted line for each plot represents the exact timing correlation (i.e. ETI = TI)...


```{r warning=FALSE, results='hide'}
# Make plots!
make_all_plots(x = "ti", y = "eti")
```

The following plots show the average pairwise diversity by fragment for each patient (Sample). The facetted plots (3X3) are showing individual runs whereas others (1X3) are showing all runs combined. Note that average pairwise diversity (APD) parameters change for each plot.


```{r warning=FALSE, results='hide'}
# Make plots!
make_all_plots(x = "ti", y = "apd")
```

The following plots show the log viral load versus average pairwise diversity by fragment and patient (Sample). The plots are showing all runs combined. Note that average pairwise diversity (APD) parameters change for each plot.


```{r warning=FALSE, results='hide'}
# Make plots!
make_all_plots(y = "apd", x = "vl")
```

The following plots show the log viral load versus mean absolute error (estimated TI - actual TI) by fragment and patient (Sample). The plots are showing all runs combined. Note that average pairwise diversity (APD) parameters change for each plot.


```{r warning=FALSE, results='hide'}
# Make plots!
make_all_plots(y = "mae", x = "vl")
```

The following plot compares the viral load over time for our data and the Neher test cohort data.

```{r warning=FALSE, results='hide'}
# Make plots for Neher comparison!
plot_model_compare(data = all_runs, test_data = neher_data)
```

